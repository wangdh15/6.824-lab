## mapreduce lab

### 1. worker的工作

worker通过调用master的RPC来申请任务，返回的任务包含三种类型：
1. waiting: 表示当前没有更多的任务，worker随机休眠一段时间。
2. map： worker执行map任务。
3. reduce: worker执行reduce任务。

worker退出的条件是，RPC调用发生了失败。这里不考虑网络故障导致worker无法访问master的情况。

worker在写文件的时候，不能直接写，这是因为有可能两个worker在对同一个文件进行写操作。所以需要先下一个临时文件，
然后采用原子改名的操作。

map任务将一个文件的内容按照key进行划分为Nreduce个文件，且命名为mr-X-Y，X为任务编号，从任务参数中获取，Y为reduce编号
reduce任务将多个文件中的内容读取进来，然后按照key进行聚合，再调用reduce函数，并将结果写入到mr-out-X。
写文件的时候，需要先写入到一个零时文件中，然后原子改名。


### 2. master的工作

1. 维护几个个队列：
    - 未分配的map
    - 已分配未完成的map
    - 未分配的reduce
    - 已分配未完成的reduce

2. 在分配了一个map或者reduce任务之后，同时起一个timer，采用select来进行多路复用，如果发生了超时，则将对应任务放回未分配的map中。
3. 当map收到了一个完成的回复，可能是如下几种情况：
    - 这个任务在已分配未完成的队列中
        + 将该任务从对应队列中删除即可
    - 这个任务在未分配的队列中（超时了然后放回去了，但是还没有分配给新的worker）
        + 将该任务从对应队列中删除
    - 这个任务不在两个队列中（超时了，重启了一个worker，且这个worker完成了，然后进入了reduce阶段，然后才收到回复）
        + 直接将结果丢弃
4. 一个reduce任务也可能是同样的。
5. 当master将map任务都下发出去之后，可能还没有收到全部map的返回，这个时候还不能够启动reduce，所以如果这个时候收到了worker的请求，则返回一个waiting的任务类型即可。
6. 一个Done是否结束的标志是：上述所有的队列都为空
7. master的各个RPC可能是并发的，所以访问共享的数据结构的时候需要加锁。
